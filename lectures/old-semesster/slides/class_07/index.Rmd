---
title: "Review of the Greenhouse Effect"
class_no: 7
class_date: "Monday, February 8"
qrimage: qrcode.png
pageurl: "ees3310.jgilligan.org/slides/class_07"
pdfurl: "ees3310.jgilligan.org/slides/class_07/ees_3310_5310_class_07_slides.pdf"
course: "EES 3310/5310"
course_name: "Global Climate Change"
author: "Jonathan Gilligan"
semester: Spring
year: 2021
output:
  revealjg::revealjs_presentation
---
```{r setup, cache = F, echo = F, eval = T, message=F, warning=F}
knitr::opts_chunk$set(cache=TRUE, 
                      echo=FALSE, message=FALSE, warning=FALSE,
                      fig.height=9, fig.width=14, dpi=100,
                      dev='png',fig.path='assets/fig/',cache.path='./cache/')

library(rprojroot)

semester_dir <- find_rstudio_root_file()
data_dir <- file.path(semester_dir, "data")
script_dir <- file.path(semester_dir, "lecture_scripts")

source_semester_script <- function(script) {
  script_file <- file.path(script_dir, script)
  message("Running script", script_file)
  source(script_file, chdir = T)
}

eval_in_sem_script_dir <- function(expr, loc = script_dir) {
  this_dir <- getwd()
  setwd(loc)
  retval <- eval(expr)
  setwd(this_dir)
  invisible(retval)
}

library(magrittr)
library(tidyverse)

source_semester_script('modtran.R')
source_semester_script('convective_greenhouse.R')

t1l_earth <- tbr_earth * 2^0.25
```
# Review of Lapse Rates and Stability {#lapse-rate-review-sec .center}

## Terminology {#terminology}

* **Environmental Lapse**
  * Measured temperature of actual atmosphere
  * Compares one bit of air at one height with another bit at another height.
  * Changes from one time and place to another.
* {+} **Adiabatic Lapse**
  * Change in a single parcel of air as it moves up or down
  * "**Adiabatic**" means no heat flowing in or out
    * **Adiabatic changes</b> are reversible**
    * **Heat flow** is irreversible

## Perspective {#stability}

* {+} Stable:
  * Environmental lapse \(\le\) adiabatic lapse
* {+} Unstable:
  * Environmental lapse > adiabatic lapse
* {+} Adiabatic lapse:
  * Dry: 10 K/km
  * Moist: 4-8 K/km (depends on humidity)
* {+} Pure radiative equilibrium ( Layer models):
  * Would produce lapse of **16 K/km**: unstable
* {+} Radiative-Convective equilibrium:
  * Convection modifies environmental lapse
  * Normal environmental lapse is roughly **6 K/km**
    <br/>(typical *moist adiabatic lapse rate*)

# Band Saturation {#saturation-sec .center}

## Band Saturation {#band-saturation .eightyfive}

* Small concentrations of greenhouse gas
  * {+} Small absorption
  * {+} Absorption rises rapidly as more gas is added
  * {+} Doubling the amount of gas doubles the absorption
* {+} Saturation
  * {+} Absorption can't be more than 100%
  * {+} As absorption gets large, adding more gas has a diminishing effect
* {+} "Band" saturation
  * {+} Gases absorb in "bands"
    * Strong absorption in the middle of the band
      * This saturates first
    * {+} Weak absorption on both sides
      * The "wings" of the band
      * These saturate more slowly
  * {+} After the center of the band saturates, the wings gradually become
    more saturated
    * The saturated region of the spectrum gradually gets wider and wider
  * {+} Total absorption rises by the same amount every time the amount of 
    gas doubles

## Set up MODTRAN: {#setup_modtran .eighty}

* Open MODTRAN <http://climatemodels.uchicago.edu/modtran>
* Set "Location" to "1976 U.S. Standard Atmosphere".
* Set altitude to 20 km.
* Set all greenhouse gases to zero.

<iframe src="https://climatemodels.jgilligan.org/modtran/" style="height:750px;width:1500px;"></iframe>

## No CO~2~ {#co2_00000 data-transition="fade-out"}
```{r no.ghg, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_00000_ppm.txt'))$mtime)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_00000_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
i_ref <- mod_data$i_out
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
i_list <- data.frame(co2 = mod_data$co2, i = mod_data$i_out)
last_i <- i_ref
plot(p)
```

## 1 ppm CO~2~ {#co2_00001 data-transition="fade"}
```{r co2.00001, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_00001_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_00001_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```


## 2 ppm CO~2~ {#co2_00003_125 data-transition="fade"}
```{r co2.00002, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_00002_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_00002_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```


## 4 ppm CO~2~ {#co2_00004 data-transition="fade"}
```{r co2.00004, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_00004_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_00004_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```


## 8 ppm CO~2~ {#co2_00008 data-transition="fade"}
```{r co2.00008, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_00008_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_00008_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```

## 16 ppm CO~2~ {#co2_00016 data-transition="fade"}
```{r co2.00016, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_00016_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_00016_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```

## 32 ppm CO~2~ {#co2_00032 data-transition="fade"}
```{r co2.00032, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_00032_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_00032_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```


## 64 ppm CO~2~ {#co2_00064 data-transition="fade"}
```{r co2.00064, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_00064_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_00064_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```

## 128 ppm CO~2~ {#co2_00128 data-transition="fade"}
```{r co2.00128, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_00128_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_00128_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```

## 256 ppm CO~2~ {#co2_00256 data-transition="fade"}
```{r co2.00256, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_00256_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_00256_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```

## 512 ppm CO~2~ {#co2_00512 data-transition="fade"}
```{r co2.00512, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_00512_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_00512_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```

## 1024 ppm CO~2~ {#co2_01024 data-transition="fade"}
```{r co2.01024, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_01024_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_01024_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```

## 2048 ppm CO~2~ {#co2_02048 data-transition="fade-in"}
```{r co2.02048, echo=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','20km_sat','co2_02048_ppm.txt'))$mtime, last_i)}
mod_data <- read_modtran(file.path(data_dir,'modtran','20km_sat','co2_02048_ppm.txt'))
pco2 <- mod_data$co2
alt <- mod_data$alt
p <- plot_modtran(modtran_data = mod_data, 
                  descr = str_c(pco2, ' ppm CO2, ', alt, ' km'),
                  legend_size=0.05, legend_text_size=25, text_size = 25, 
                  annotate_size = NA)
last_i <- mod_data$i_out
i_list <- rbind(i_list, data.frame(co2 = mod_data$co2, i = mod_data$i_out))
plot(p)
```

# Vertical Structure and Saturation {#vertical-saturation-sec .center}

## Set up MODTRAN: {#setup-modtran .eighty}

* Open MODTRAN <http://climatemodels.uchicago.edu/modtran/>
* Set location to "1976 U.S. Standard Atmosphere".
* Set altitude to **70 km**.
* Set CO~2~ to 0.1 ppm, all other gases to zero.
* Now increase CO~2~ by factors of 10 (1, 10, 100, 1000, 10000)
* Notice differences between **70 km** and **20 km**.

## 0.1 ppm CO~2~  {#vert-co2-00001 data-transition="fade-out"}
```{r co2.00000_1.hi, echo=FALSE, warning=FALSE, message=FALSE}
pco2 = 0.1
z = 70
atmos = "std"
mod_file = file.path(data_dir, 'modtran', sprintf('%dkm_sat', z), 
                     sprintf('co2_00000_10_%s.txt', atmos))
if (! file.exists(mod_file)) {
  stop("Can't find file ", mod_file)
  # mod_data = run_modtran(mod_file, co2_ppm = pco2, ch4_ppm = 0, trop_o3_ppb = 0, 
  #                        strat_o3_scale = 0, h2o_scale = 0, freon_scale = 0, 
  #                        delta_t = 0, h2o_fixed = "vapor pressure", 
  #                        atmosphere = "tropical", clouds = "none", 
  #                        altitude_km = z, looking = "down")
} else {
  mod_data <- read_modtran(mod_file)
}
# i_out_table <- data.frame(pco2 = mod_data$co2, i_out = mod_data$i_out, 
# delta = NA, increment = NA)
i_out_ref  <- mod_data$i_out
last_i_out <- mod_data$i_out

gl <- plot_modtran(modtran_data = mod_data, 
                   descr = sprintf('%.1 f ppm CO2, %d km', pco2, z),
           legend_size=0.05, legend_text_size=25, text_size = 25, 
           annotate_size = NA)

plot(gl)
```

## 1 ppm CO~2~  {#vert-co2-00001 data-transition="fade"}
```{r co2.00001.hi, echo=FALSE, warning=FALSE, message=FALSE}
pco2 = 1
z = 70
atmos = "std"
mod_file = file.path(data_dir, 'modtran', sprintf('%dkm_sat', z), 
                     sprintf('co2_%05d_%s.txt', pco2, atmos))
if (! file.exists(mod_file)) {
  stop("Can't find file ", mod_file)
  # mod_data = run_modtran(mod_file, co2_ppm = pco2, ch4_ppm = 0, trop_o3_ppb = 0, 
  #                        strat_o3_scale = 0, h2o_scale = 0, freon_scale = 0, 
  #                        delta_t = 0, h2o_fixed = "vapor pressure", 
  #                        atmosphere = "tropical", clouds = "none", 
  #                        altitude_km = z, looking = "down")
} else {
  mod_data <- read_modtran(mod_file)
}
# i_out_table <- bind_rows(i_out_table,
#                          data.frame(pco2 = mod_data$co2, 
#                                     i_out = mod_data$i_out,
#                                     delta = mod_data$i_out - i_out_ref,
#                                     increment = mod_data$i_out - last_i_out))
i_out_ref  <- mod_data$i_out
last_i_out <- mod_data$i_out

gl <- plot_modtran(modtran_data = mod_data, 
                   descr = sprintf('%d ppm CO2, %d km', pco2, z),
           legend_size=0.05, legend_text_size=25, text_size = 25, 
           annotate_size = NA)

plot(gl)
```

## 10 ppm CO~2~  {#vert-co2-00010 data-transition="fade"}
```{r co2.00010.hi, echo=FALSE, warning=FALSE, message=FALSE, dependson = "co2.00001.hi"}
pco2 = 10
z = 70
atmos = "std"
mod_file = file.path(data_dir, 'modtran', sprintf('%dkm_sat', z), 
                     sprintf('co2_%05d_%s.txt', pco2, atmos))
if (! file.exists(mod_file)) {
  stop("Can't find file ", mod_file)
  # mod_data = run_modtran(mod_file, co2_ppm = pco2, ch4_ppm = 0, trop_o3_ppb = 0, 
  #                        strat_o3_scale = 0, h2o_scale = 0, freon_scale = 0, 
  #                        delta_t = 0, h2o_fixed = "vapor pressure", 
  #                        atmosphere = "tropical", clouds = "none", 
  #                        altitude_km = z, looking = "down")
} else {
  mod_data <- read_modtran(mod_file)
}
# i_out_table <- bind_rows(i_out_table,
#                          data.frame(pco2 = mod_data$co2, 
#                                     i_out = mod_data$i_out,
#                                     delta = mod_data$i_out - i_out_ref,
#                                     increment = mod_data$i_out - last_i_out))
i_out_ref  <- mod_data$i_out
last_i_out <- mod_data$i_out

gl <- plot_modtran(modtran_data = mod_data, 
                   descr = sprintf('%d ppm CO2, %d km', pco2, z),
           legend_size=0.05, legend_text_size=25, text_size = 25, 
           annotate_size = NA)

plot(gl)
```

## 100 ppm CO~2~  {#vert-co2-00100 data-transition="fade"}
```{r co2.00100.hi, echo=FALSE, warning=FALSE, message=FALSE, dependson = "co2.00010.hi"}
pco2 = 100
z = 70
atmos = "std"
mod_file = file.path(data_dir, 'modtran', sprintf('%dkm_sat', z), 
                     sprintf('co2_%05d_%s.txt', pco2, atmos))
if (! file.exists(mod_file)) {
  stop("Can't find file ", mod_file)
  # mod_data = run_modtran(mod_file, co2_ppm = pco2, ch4_ppm = 0, trop_o3_ppb = 0, 
  #                        strat_o3_scale = 0, h2o_scale = 0, freon_scale = 0, 
  #                        delta_t = 0, h2o_fixed = "vapor pressure", 
  #                        atmosphere = "tropical", clouds = "none", 
  #                        altitude_km = z, looking = "down")
} else {
  mod_data <- read_modtran(mod_file)
}
# i_out_table <- bind_rows(i_out_table,
#                          data.frame(pco2 = mod_data$co2, 
#                                     i_out = mod_data$i_out,
#                                     delta = mod_data$i_out - i_out_ref,
#                                     increment = mod_data$i_out - last_i_out))
i_out_ref  <- mod_data$i_out
last_i_out <- mod_data$i_out

gl <- plot_modtran(modtran_data = mod_data, 
                   descr = sprintf('%d ppm CO2, %d km', pco2, z),
           legend_size=0.05, legend_text_size=25, text_size = 25, 
           annotate_size = NA)

plot(gl)
```

## 1000 ppm CO~2~  {#vert-co2-01000 data-transition="fade"}
```{r co2.01000.hi, echo=FALSE, warning=FALSE, message=FALSE, dependson = "co2.00100.hi"}
pco2 = 1000
z = 70
atmos = "std"
mod_file = file.path(data_dir, 'modtran', sprintf('%dkm_sat', z), 
                     sprintf('co2_%05d_%s.txt', pco2, atmos))
if (! file.exists(mod_file)) {
  stop("Can't find file ", mod_file)
  # mod_data = run_modtran(mod_file, co2_ppm = pco2, ch4_ppm = 0, trop_o3_ppb = 0, 
  #                        strat_o3_scale = 0, h2o_scale = 0, freon_scale = 0, 
  #                        delta_t = 0, h2o_fixed = "vapor pressure", 
  #                        atmosphere = "tropical", clouds = "none", 
  #                        altitude_km = z, looking = "down")
} else {
  mod_data <- read_modtran(mod_file)
}
# i_out_table <- bind_rows(i_out_table,
#                          data.frame(pco2 = mod_data$co2, 
#                                     i_out = mod_data$i_out,
#                                     delta = mod_data$i_out - i_out_ref,
#                                     increment = mod_data$i_out - last_i_out))
i_out_ref  <- mod_data$i_out
last_i_out <- mod_data$i_out

gl <- plot_modtran(modtran_data = mod_data, 
                   descr = sprintf('%d ppm CO2, %d km', pco2, z),
           legend_size=0.05, legend_text_size=25, text_size = 25, 
           annotate_size = NA)

plot(gl)
```

## 10,000 ppm CO~2~  {#vert-co2-10000 data-transition="fade-in"}
```{r co2.10000.hi, echo=FALSE, warning=FALSE, message=FALSE, dependson = "co2.01000.hi"}
pco2 = 10000
z = 70
atmos = "std"
mod_file = file.path(data_dir, 'modtran', sprintf('%dkm_sat', z), 
                     sprintf('co2_%05d_%s.txt', pco2, atmos))
if (! file.exists(mod_file)) {
  stop("Can't find file ", mod_file)
  # mod_data = run_modtran(mod_file, co2_ppm = pco2, ch4_ppm = 0, trop_o3_ppb = 0, 
  #                        strat_o3_scale = 0, h2o_scale = 0, freon_scale = 0, 
  #                        delta_t = 0, h2o_fixed = "vapor pressure", 
  #                        atmosphere = "tropical", clouds = "none", 
  #                        altitude_km = z, looking = "down")
} else {
  mod_data <- read_modtran(mod_file)
}
# i_out_table <- bind_rows(i_out_table,
#                          data.frame(pco2 = mod_data$co2, 
#                                     i_out = mod_data$i_out,
#                                     delta = mod_data$i_out - i_out_ref,
#                                     increment = mod_data$i_out - last_i_out))
i_out_ref  <- mod_data$i_out
last_i_out <- mod_data$i_out

gl <- plot_modtran(modtran_data = mod_data, 
                   descr = sprintf('%d ppm CO2, %d km', pco2, z),
           legend_size=0.05, legend_text_size=25, text_size = 25, 
           annotate_size = NA)

plot(gl)
```

## Question {#question-3 data-transition="fade-out"}

```{r std_atmos_plot, echo=FALSE, fig.height=7, warning=FALSE, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','std_atmosphere_defaults.txt'))$mtime)}
atmos <- "std"
mod_file = file.path(data_dir, 'modtran', 
                     str_c(atmos, "atmosphere_defaults.txt", sep = "_"))
gl <- plot_modtran(mod_file, 
                   legend_size=0.05, legend_text_size=15, text_size=15, 
                   annotate_size = NA)
plot(gl)
```


* Why do we see the spike in the middle<br/>of the CO~2~ absorption feature?

## Answer {#answer-3 data-transition="fade"}

::::::: {.columns}
::: {.column .eighty style="width:49%;padding-top:1em;"}
```{r high_plot, echo=FALSE, fig.height=7, warning=FALSE, fig.width=9, fig.height=7, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','std_atmosphere_defaults.txt'))$mtime)}
atmos = "std"
z = 70
mod_file <- file.path(data_dir,'modtran',sprintf('%dkm_sat', z), 
                      str_c('modtran', atmos, 'defaults.txt', sep = "_"))
mod_data <- read_modtran(mod_file)
gl <- plot_modtran(mod_data, 
                   descr = sprintf('%.0 f ppm CO2, %d km', mod_data$co2, 
                                   mod_data$alt),
                   lambda = c(1, 2, 2.5, 3, 3.5, 4, 5:10, 12, 14, 17, 20, 25, 
                              30, 40, 50, 100),
                   tmax = 280, nc = 4,
                   legend_size=0.05, legend_text_size=15, text_size = 15, 
                   annotate_size = NA)
plot(gl)
```
:::
::: {.column .eighty style="width:49%;padding-top:1em;"}
```{r low_plot, echo=FALSE, fig.height=7, warning=FALSE, fig.width=9, fig.height=7, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','std_atmosphere_defaults.txt'))$mtime)}
z <- 20
atmos = "std"
mod_file <- file.path(data_dir,'modtran',sprintf('%dkm_sat', z), 
                      str_c('modtran', atmos, 'defaults.txt', sep = "_"))
mod_data <- read_modtran(mod_file)
gl <- plot_modtran(mod_data,
                   descr = sprintf('%.0 f ppm CO2, %d km', mod_data$co2, 
                                   mod_data$alt),
                   lambda = c(1, 2, 2.5, 3, 3.5, 4, 5:10, 12, 14, 17, 20, 25, 
                              30, 40, 50, 100),
                   tmax = 280, nc = 4,
                   legend_size=0.05, legend_text_size=15, text_size = 15, 
                   annotate_size = NA)
plot(gl)
```
:::
::::::

## Answer {#answer-3b data-transition="fade-in"}

::::::: {.columns}
::: {.column .eighty style="width:49%;padding-top:1em;"}
```{r high_plot_2, ref.label="high_plot", echo=FALSE, fig.height=7, warning=FALSE, fig.width=9, fig.height=7}
```
:::
::: {.column .eighty style="width:49%;padding-top:1em;"}
```{r modtran_profile, echo=FALSE, fig.height=7, warning=FALSE, fig.width=9, fig.height=7, cache.extra=c(data_dir,file.info(file.path(data_dir,'modtran','std_atmosphere_defaults.txt'))$mtime)}
z = 20
atmos = "std"
mod_file <- file.path(data_dir,'modtran', sprintf('%2dkm_sat', z), 
                      str_c('modtran', atmos, 'defaults.txt', sep = "_"))
mod_profile <- read_modtran_profile(mod_file)
marg <- theme_get()$plot.margin
marg[2] <- unit(1, "line")
gl <- mod_profile %>% filter(Z <= 50) %>% 
  ggplot(aes(x = T, y = Z)) +
  geom_path(size = 1) +
  scale_x_continuous(breaks = seq(200, 300, 10), 
                     limits=c(215,290),
                     expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(x = "T (Kelvin)", y = "Altitude (km)") +
  theme(plot.margin = marg)
plot(gl)
```
:::
::::::

## Question {#question-4 data-transition="fade-out"}

```{r h2o.question, ref.label="std_atmos_plot", fig.height=7}
```

* Water vapor absorption is completely saturated.
  * Why does water vapor emit at warmer temperatures than CO~2~?

## Answer {#answer-4 data-transition="fade-in"}

::: {.bare style="margin-top:1rem;"}
```{r h2o_answer, fig.height=7}
z = 70
atmos = "std"
mod_file <- file.path(data_dir,'modtran', sprintf('%2dkm_sat', z), 
                      str_c('modtran', atmos, 'defaults.txt', sep = "_"))
mod_prof <- read_modtran_profile(filename = mod_file)
mod_prof <- mod_prof %>% select(Z, P, H2O, CO2) %>% 
  pivot_longer(cols=c(H2O, CO2), names_to = "Molecule", values_to = "ppm") %>%
  mutate(mbar = ppm * 1E-6 * P)
marg <- theme_get()$plot.margin
marg[2] <- unit(1, "lines")

log_format <- function(x) {
  lx <- log10(x)
  ifelse(lx < 0,
    math_format(10^.x)(log10(x)),
    x)
}

gl <- mod_prof %>%
  filter(Z <= 25) %>%
  ggplot(aes(x = mbar, y = Z, color = Molecule)) +
  geom_path(size = 1.5) +
  # scale_x_continuous(limits = c(-10, 6000), expand = c(0,0), 
  #                    breaks = seq(0, 10000, 500)) +
  scale_x_log10(breaks = c(1E-4, 1E-3, 1E-2, 1E-1, 1.0, 10),
                labels = label_number(trim = TRUE, drop0trailing = TRUE)) +
  scale_y_continuous(expand = c(0,0)) +
  scale_color_brewer(palette = "Dark2", breaks = c("CO2", "H2O"),
                     labels = expression(CO[2], H[2] * O)) +
  labs(x = "Partial pressure (mbar)", y = "Altitude (km)") +
  theme(legend.position = c(0.99, 0.99), legend.justification = c(1,1),
        legend.key.width = unit(2, "lines"),
        plot.margin = marg)
plot(gl)
```
:::
::: {.bare .eighty}
* {+} Near the ground, there is much more water vapor (15 times more)
* {+} Above about 7 km, there is much more CO~2~ (100 times more at 20 km)
  * {+} Water vapor concentrations become small enough to be transparent to space
    <br/>at a much lower altitude than CO~2~
:::

# Convection and the Greenhouse Effect {#convective_greenhouse_sec .center}

## Another Perspective on Band Saturation {#band-saturation-perspective .ninety}

* Instead of thinking of saturation as increasing absorption ...
* {+} Think of saturation as raising the skin height
  * {+} Skin height = the height at which the atmosphere becomes transparent 
    enough to radiate out to space
    * The height of the top of the atmospheric layer in a layer model
  * {+} The atmosphere becomes opaque at a certain wavelength when there are
    more than a certain number of molecules per square meter of an absorbing gas 
    overhead.
    * {+} The higher you go, the fewer molecules are overhead and the more are
      below your feet.
    * {+} The atmosphere gradually becomes more transparent, but we pretend that this
      happens suddenly at a certain height.
    * {+} Pressure and density fall exponentially as you go higher, so this 
      approximation is reasonable.
* {+} After band saturation sets in, adding more greenhouse gas raises the skin
  height.

## Saturation, Convection, and the Greenhouse Effect {#gw-baseline .ninety data-transition="fade"}

```{r baseline.conv.gh, echo=FALSE, fig.height=7, fig.width=10}
angle = 39
adiabat_labels <- rep_len('environ. lapse rate',2)
plot.conv.greenhouse(z.ratio = 1.3, angle=angle, 
                     reserve = 1.5,
                     adiabat.labels = adiabat_labels, plot.warming=FALSE)
```

* Skin temp: 
  $T_{\text{skin}} = T_{\text{bare rock}} = `r round(tbr_earth)`~\text{K}$.
* Ground temp: 
  $T_{\text{ground}} = T_{\text{skin}} + h_{\text{skin}} \times \text{ELR}$
  * ELR = Environmental Lapse Rate

## Global warming {#gw-convect .ninety data-transition="fade"}

```{r warm.conv.gh, echo=FALSE, fig.height=7, fig.width=10, dependson="baseline.conv.gh"}
plot.conv.greenhouse(z.ratio = 1.3, angle=angle, 
                     reserve = 1.5,
                     adiabat.labels = adiabat_labels, plot.warming=TRUE)
```

* Greater CO~2~ $\rightarrow$ greater skin height.
* Warming: $\Delta T_{\text{ground}} = \Delta h_{\text{skin}} \times \text{env. lapse}$


# Review of the Greenhouse Effect {#greenhouse-review-sec .center}

## Review of the Greenhouse Effect {#greenhouse-review .eighty}

:::::: {.columns .vtop}
::: {.column}
#. **Start with bare-rock temperature**
   * This becomes skin temperature
#. {+} **Add simple layer atmosphere:**
   * {+} Completely black to longwave radiation
   * {+} Top of atmosphere: skin temperature (same as bare-rock)
   * {+} Atmosphere insulates surface $\Rightarrow$ surface heats up
   * {+} More layers $\Rightarrow$ bigger greenhouse effect
#. {+} **Realistic longwave absorption:** 
   * Atmosphere is not black
   * Absorption depends on wavelength
:::
::: {.column}
4. {+} **Radiative-Convective equilibrium:**
   * {+} Pure radiative equilibrium would have _huge_ environmental lapse rate
     * 16 K/km
   * {+} Big lapse rate is unstable $\Rightarrow$ convection
     * {+} ELR (16 K/km) > ALR (6--10 K/km)
     * {+} Convection mixes hot & cold air $\Rightarrow$
       reduces environmental lapse until it becomes stable
     * {+} Reduces greenhouse effect
   * {+} **Alternate perspective:**
     * Think of greenhouse effect in terms of raising the skin height instead
       of blocking heat flow.
     * T~skin~ is always T~bare rock~
     * T~ground~ = T~skin~ + h~skin~ &times; Environmental Lapse Rate
:::
::::::

# Questions & Discussion of Greenhouse Effect {#discussion-sec .center}
